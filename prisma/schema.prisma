// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "mysql"
}

// ENUMS
enum UserRole {
  ADMIN
  RECEPTIONIST
  TECHNICIAN
  STORE_MANAGER
  CUSTOMER
}

enum TicketStatus {
  RECEIVED
  APPROVED
  DIAGNOSIS
  WAITING_APPROVAL
  WAITING_PARTS
  UNDER_REPAIR
  READY
  DELIVERED
  CANCELLED
}

enum ReceptionistTicketStatus {
  RECEIVED
  APPROVED
  READY
  DELIVERED
  CANCELLED
}
enum TechnicianTicketStatus {
  DIAGNOSIS
  UNDER_REPAIR
  WAITING_APPROVAL
  WAITING_PARTS 
}

enum DeviceType {
  LAPTOP
  CAMERA
  PRINTER
  OTHER
}

enum Branches {
  FARQ
  SOUQ
}

// SCHEMAS
model User {
  id                String     @id @default(cuid())
  name              String
  email             String     @unique
  password          String
  passwordConfirm   String     @default("")
  phone             String     @unique
  role              UserRole
  isActive          Boolean    @default(true)
  branch            Branches?

  // Relations
  assignedTickets   Ticket[]   @relation("AssignedTechnician")
  customer          Customer?  @relation("UserCustomer")

  // OTP Fields
  isPhoneVerified       Boolean   @default(false)
  phoneVerificationOTP  String?
  otpExpiresAt          DateTime?
  otpAttempts           Int       @default(0)

  // Password Fields 
  passwordChangedAt    DateTime @default(now())
  passwordResetToken   String?   @unique
  passwordResetExpires DateTime @default(now()) 


  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt @default(now())

  
}

model Customer {  
  id        String    @id @default(cuid())
  name      String
  phone     String    @unique
  email     String?   @unique

  userId    String?   @unique
  user      User?     @relation(name: "UserCustomer", fields: [userId], references: [id])

  // device           Device[]     @relation(fields: [deviceId], references: [id])
  // deviceId         String

  tickets   Ticket[]
  devices   Device[]
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
}

model Ticket {
  id               String       @id @default(cuid())
  
  ticketNumber     String       @unique   // SG-2025-0001 (generated in backend)
  deviceCode       String       @unique   // SJ-A8X92KD992

  // Relations
  device           Device     @relation(fields: [deviceId], references: [id])
  deviceId         String

  customer         Customer     @relation(fields: [customerId], references: [id])
  customerId       String

  assignedTech     User?        @relation("AssignedTechnician", fields: [assignedTechId], references: [id])
  assignedTechId   String?


  status           TicketStatus @default(RECEIVED)
  urgent           Boolean      @default(false)
  branch           Branches       
  notes            String?
  password         String?

  includesBattery  Boolean      @default(false)
  includesCharger  Boolean      @default(false)
  missingSkrews    Boolean      @default(false)
  hasScratches     Boolean      @default(false)
  wantsBackup      Boolean      @default(false)
  underWarranty    Boolean      @default(false)


  parts            TicketPart[]
  repairs          TicketRepair[]

  totalRepairsCost Float      @default(0)
  totalPartsCost   Float      @default(0)
  totalPrice       Float      @default(0)

  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
}

model Part {
  id              String        @id @default(cuid())
  name            String
  model           String?
  sellingPrice    Float
  quantity        Int           @default(0)
  minimumQuantity Int           @default(0)
  branch          Branches
  // Relations
  ticketParts     TicketPart[]
  // partRequests    PartRequest[] // if technician requested this part

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@unique([name, branch])
}

model TicketPart {
  id          String   @id @default(cuid())

  ticket      Ticket   @relation(fields: [ticketId], references: [id])
  ticketId    String

  partId      String
  part        Part     @relation(fields: [partId], references: [id])

  quantity    Int      
  priceAtUse  Float    // store the price used at that time (important!)

  createdAt   DateTime @default(now())

  @@unique([partId, ticketId])
}

model Repair {
  id           String        @id @default(cuid())
  
  name         String        @unique
  price        Float         @default(0)

  repairs      TicketRepair[]

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model TicketRepair {
  id            String      @id @default(cuid())

  ticketId      String
  ticket        Ticket      @relation(fields: [ticketId], references: [id])

  repairId      String      
  repair        Repair      @relation(fields: [repairId], references: [id])

  priceAtUse    Float       // store the price used at that time (important!)
  notes         String?

  createdAt     DateTime    @default(now())

  @@unique([repairId, ticketId])
}

model Device {
  id             String       @id @default(cuid())
  serialNumber   String?      @unique  // <--- correct
  type           DeviceType
  otherType      String?
  brand          String
  model          String?
  color          String
  tickets        Ticket[]
  customer       Customer     @relation(fields: [customerId], references: [id])
  customerId     String
  createdAt      DateTime     @default(now())
}         





